<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>F1 Analytics & Paddock</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&display=swap');
        body { background-color: #0a0a0a; color: #eeeeee; font-family: 'Inter', sans-serif; overflow-x: hidden; }
        .f1-border { border-left: 5px solid #e10600; }
        .card { background: linear-gradient(145deg, #1a1a1a, #151515); border: 1px solid #252525; border-radius: 12px; }
        .blur-bg { filter: blur(12px); pointer-events: none; opacity: 0.3; }
        .tab-active { border-bottom: 4px solid #e10600; color: #e10600; font-weight: 900; }
        
        input[type=range] { -webkit-appearance: none; background: transparent; }
        input[type=range]::-webkit-slider-runnable-track { background: #333; height: 6px; border-radius: 3px; }
        input[type=range]::-webkit-slider-thumb { -webkit-appearance: none; height: 22px; width: 22px; border-radius: 50%; background: #e10600; cursor: pointer; margin-top: -8px; box-shadow: 0 0 10px rgba(225, 6, 0, 0.5); }
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #0a0a0a; }
        ::-webkit-scrollbar-thumb { background: #333; border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: #e10600; }

        .nav-btn { font-size: 14px; letter-spacing: 0.1em; transition: all 0.3s; }
        .nav-btn:hover { color: #e10600; }
    </style>
</head>
<body class="p-4 md:p-8">

    <div id="auth-modal" class="fixed inset-0 bg-black/95 backdrop-blur-md z-[100] flex items-center justify-center p-4">
        <div class="card w-full max-w-md p-10 border-t-8 border-red-600 shadow-2xl">
            <h2 id="auth-title" class="text-4xl font-black italic uppercase text-center mb-10 text-white tracking-tighter">F1 <span class="text-red-600">Access</span></h2>
            <form onsubmit="handleAuth(event)" class="space-y-6">
                <input type="text" id="auth-user" placeholder="Username" required class="w-full bg-black border border-zinc-800 p-4 rounded-lg outline-none focus:border-red-600 text-white text-lg">
                <input type="password" id="auth-pass" placeholder="Password" required class="w-full bg-black border border-zinc-800 p-4 rounded-lg outline-none focus:border-red-600 text-white text-lg">
                <button type="submit" class="w-full bg-red-600 text-white font-black py-4 rounded-lg uppercase tracking-widest hover:bg-red-700 transition transform hover:scale-[1.02]">Confirm Credentials</button>
            </form>
            <button onclick="toggleAuthMode()" id="auth-toggle-btn" class="w-full mt-6 text-xs text-gray-500 uppercase font-bold hover:text-white transition underline decoration-red-600">New Engineer? Create Account</button>
        </div>
    </div>

    <div id="main-content" class="max-w-7xl mx-auto blur-bg">
        <header class="flex flex-col lg:flex-row justify-between items-start lg:items-center mb-12 border-b border-zinc-800 pb-8 gap-8">
            <div class="flex-1">
                <div class="flex items-center gap-6">
                    <h1 class="text-5xl font-black italic text-white tracking-tighter">FORMULA ZH</h1>
                    <button onclick="logout()" class="text-xs bg-zinc-800 text-gray-400 px-4 py-2 rounded font-black uppercase hover:bg-red-600 hover:text-white transition">Exit System</button>
                </div>
                <nav class="flex gap-8 mt-8 uppercase font-black">
                    <button onclick="switchTab('data')" id="nav-data" class="nav-btn tab-active py-2">Analytics</button>
                    <button onclick="switchTab('events')" id="nav-events" class="nav-btn py-2">Fan Events</button>
                    <button onclick="switchTab('profile')" id="nav-profile" class="nav-btn py-2">Profile</button>
                    <button onclick="switchTab('admin')" id="nav-admin" class="nav-btn py-2 hidden text-red-600 border-red-600">Admin</button>
                </nav>
            </div>
            
            <div id="header-profile-mini" class="card p-5 flex items-center gap-5 min-w-[280px] border-r-4 border-r-red-600 shadow-xl">
                <div class="w-14 h-14 bg-zinc-800 rounded-full flex items-center justify-center border-2 border-red-600">
                    <svg class="w-8 h-8 text-red-600" fill="currentColor" viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 3c1.66 0 3 1.34 3 3s-1.34 3-3 3-3-1.34-3-3 1.34-3 3-3zm0 14.2c-2.5 0-4.71-1.28-6-3.22.03-1.99 4-3.08 6-3.08 1.99 0 5.97 1.09 6 3.08-1.29 1.94-3.5 3.22-6 3.22z"/></svg>
                </div>
                <div>
                    <div id="mini-name" class="text-xl font-black text-white uppercase tracking-tighter leading-none mb-1">Guest Staff</div>
                    <div class="flex items-center gap-2">
                        <span class="text-[10px] font-bold text-gray-500 uppercase tracking-widest">Global Rank</span>
                        <span id="mini-rank" class="text-sm font-black text-red-600 font-mono">#--</span>
                    </div>
                </div>
            </div>
        </header>

        <div id="tab-data" class="grid grid-cols-1 lg:grid-cols-3 gap-10">
            <div class="lg:col-span-1">
                <h2 class="text-2xl font-black mb-6 italic uppercase flex items-center gap-3"><span class="w-3 h-8 bg-red-600"></span>Season Calendar</h2>
                <div class="mb-6 card p-6">
                    <div class="flex justify-between items-center mb-4">
                        <span id="year-display" class="text-3xl font-black italic text-red-600">2024</span>
                    </div>
                    <input type="range" id="year-slider" min="1950" max="2024" value="2024" class="w-full cursor-pointer" oninput="document.getElementById('year-display').innerText=this.value" onchange="changeYear(this.value)">
                </div>
                <div id="races-list" class="space-y-4 max-h-[60vh] overflow-y-auto pr-4"></div>
            </div>
            <div class="lg:col-span-2">
                <h2 class="text-2xl font-black mb-6 italic uppercase flex items-center gap-3"><span class="w-3 h-8 bg-white"></span>Championship Standings</h2>
                <div class="card overflow-hidden">
                    <table class="w-full text-left">
                        <thead class="bg-zinc-900/50 text-xs uppercase text-gray-500 font-mono tracking-widest border-b border-zinc-800">
                            <tr><th class="p-6 w-20">Pos</th><th class="p-6">Driver</th><th class="p-6 text-right">Points</th></tr>
                        </thead>
                        <tbody id="standings-body"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <div id="tab-events" class="hidden">
            <h2 class="text-3xl font-black italic uppercase mb-10 flex items-center gap-3"><span class="w-3 h-8 bg-red-600"></span>Predictions Paddock</h2>
            <div id="questions-list" class="grid grid-cols-1 md:grid-cols-2 gap-8"></div>
        </div>

        <div id="tab-profile" class="hidden">
            <div class="card max-w-2xl mx-auto p-12 border-l-[12px] border-red-600 relative overflow-hidden shadow-2xl">
                <div class="absolute -right-10 -bottom-10 opacity-5 text-[200px] font-black italic select-none">F1</div>
                <div class="flex flex-col md:flex-row gap-10 items-center">
                    <div class="w-32 h-32 bg-zinc-800 rounded-full border-4 border-red-600 flex items-center justify-center">
                         <svg class="w-16 h-16 text-red-600" fill="currentColor" viewBox="0 0 24 24"><path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/></svg>
                    </div>
                    <div class="text-center md:text-left">
                        <h2 id="prof-name" class="text-6xl font-black uppercase italic mb-2 text-white tracking-tighter">---</h2>
                        <p class="text-red-600 font-mono text-sm mb-8 tracking-[0.4em] uppercase font-bold italic">Authenticated Dashboard Operator</p>
                    </div>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mt-10">
                    <div class="bg-black/50 p-8 rounded-xl border border-zinc-800">
                        <div class="text-xs text-gray-500 uppercase font-black mb-2 tracking-widest">Experience Points</div>
                        <div id="prof-xp" class="text-5xl font-black text-white">0</div>
                    </div>
                    <div class="bg-black/50 p-8 rounded-xl border border-zinc-800">
                        <div class="text-xs text-gray-500 uppercase font-black mb-2 tracking-widest">Global Standings</div>
                        <div id="prof-rank" class="text-5xl font-black text-red-600">#--</div>
                    </div>
                </div>
            </div>
        </div>

        <div id="tab-admin" class="hidden">
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-10">
                <div class="card p-8 border-t-8 border-red-600">
                    <h3 class="text-2xl font-black italic uppercase mb-8">Deploy <span class="text-red-600">New Prediction</span></h3>
                    <form onsubmit="handleCreateQuestion(event)" class="space-y-6">
                        <input type="text" id="admin-q-title" class="w-full bg-black border border-zinc-800 p-4 rounded-lg text-lg outline-none focus:border-red-600" placeholder="Question Title">
                        <textarea id="admin-q-text" class="w-full bg-black border border-zinc-800 p-4 rounded-lg text-lg outline-none focus:border-red-600 h-32" placeholder="Describe the event..."></textarea>
                        <input type="number" id="admin-q-xp" class="w-full bg-black border border-zinc-800 p-4 rounded-lg text-lg outline-none focus:border-red-600" placeholder="Reward XP">
                        <input type="text" id="admin-q-options" class="w-full bg-black border border-zinc-800 p-4 rounded-lg text-lg outline-none focus:border-red-600" placeholder="Options (comma separated)">
                        <button type="submit" class="w-full bg-red-600 text-white font-black py-4 rounded-lg uppercase tracking-widest hover:bg-red-700 transition transform hover:scale-[1.01]">Push to Paddock</button>
                    </form>
                </div>
                <div class="card p-8 border-t-8 border-white">
                    <h3 class="text-2xl font-black italic uppercase mb-8 text-white">Resolve <span class="text-gray-500">Live Events</span></h3>
                    <div id="admin-questions-list" class="space-y-6 max-h-[600px] overflow-y-auto pr-4"></div>
                </div>
            </div>
        </div>
    </div>

    <div id="race-modal" class="fixed inset-0 bg-black/98 hidden z-[110] flex items-center justify-center p-4 backdrop-blur-sm">
        <div class="card w-full max-w-3xl max-h-[90vh] flex flex-col border-t-8 border-red-600 relative shadow-[0_0_50px_rgba(225,6,0,0.2)]">
            <button onclick="closeModal('race-modal')" class="absolute top-6 right-6 text-3xl text-gray-500 hover:text-red-600 transition">✕</button>
            <div id="race-modal-header" class="p-8 pb-4"></div>
            <div id="race-modal-body" class="p-8 pt-0 overflow-y-auto"></div>
        </div>
    </div>

    <div id="driver-modal" class="fixed inset-0 bg-black/98 hidden z-[110] flex items-center justify-center p-4 backdrop-blur-sm">
        <div class="card w-full max-w-lg p-10 relative border-t-8 border-red-600 shadow-[0_0_50px_rgba(225,6,0,0.2)]">
            <button onclick="closeModal('driver-modal')" class="absolute top-6 right-6 text-3xl text-gray-500 hover:text-red-600 transition">✕</button>
            <div id="driver-modal-content"></div>
        </div>
    </div>

    <script>
        const BASE_URL = 'http://localhost:8080/api'; 
        let state = { year: 2024, isLoginMode: true, token: localStorage.getItem('f1_token') };
        const getV = (obj, key) => obj && (obj[key] ?? obj[key.toLowerCase()] ?? '');

        async function handleAuth(e) {
            e.preventDefault();
            const username = document.getElementById('auth-user').value;
            const password = document.getElementById('auth-pass').value;
            const url = state.isLoginMode ? '/auth/login' : '/auth/register';
            try {
                const res = await fetch(`${BASE_URL}${url}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username, password })
                });
                const data = await res.json();
                if (!res.ok) throw new Error(data.error || "Auth Error");
                if (state.isLoginMode) {
                    localStorage.setItem('f1_token', data.token);
                    state.token = data.token;
                    enterDashboard();
                } else {
                    alert("Success! Now please login.");
                    toggleAuthMode();
                }
            } catch (err) { alert(err.message); }
        }

        function toggleAuthMode() {
            state.isLoginMode = !state.isLoginMode;
            document.getElementById('auth-title').innerHTML = state.isLoginMode ? 'F1 <span class="text-red-600">Access</span>' : 'F1 <span class="text-red-600">Registry</span>';
            document.getElementById('auth-toggle-btn').innerText = state.isLoginMode ? 'New Engineer? Create Account' : 'Back to Secure Login';
        }

        function enterDashboard() {
            document.getElementById('auth-modal').classList.add('hidden');
            document.getElementById('main-content').classList.remove('blur-bg');
            loadProfile(); 
            init();
        }

        async function fetchWithAuth(url, options = {}) {
            const token = localStorage.getItem('f1_token');
            try {
                const res = await fetch(url, {
                    ...options,
                    headers: { 
                        ...options.headers, 
                        'Authorization': `Bearer ${token}`, 
                        'Content-Type': 'application/json' 
                    }
                });
                if (res.status === 401) logout();
                return await res.json();
            } catch (err) { return null; }
        }

        function switchTab(tab) {
            ['data', 'events', 'profile', 'admin'].forEach(t => {
                const content = document.getElementById(`tab-${t}`);
                const nav = document.getElementById(`nav-${t}`);
                if (content) content.classList.add('hidden');
                if (nav) nav.classList.remove('tab-active');
            });
            document.getElementById(`tab-${tab}`).classList.remove('hidden');
            document.getElementById(`nav-${tab}`).classList.add('tab-active');
            if (tab === 'events') loadQuestions();
            if (tab === 'profile') loadProfile();
            if (tab === 'admin') loadAdminQuestions();
        }

        async function loadRaces() {
            const data = await fetchWithAuth(`${BASE_URL}/f1/races?year=${state.year}`);
            if (!data) return;
            document.getElementById('races-list').innerHTML = data.map(r => `
                <div onclick="openRaceDetail(${getV(r, 'RaceID')})" class="card p-5 flex justify-between items-center f1-border hover:bg-zinc-800 cursor-pointer transition transform hover:translate-x-2">
                    <div class="font-black text-white uppercase italic text-lg tracking-tighter">${getV(r, 'Name')}</div>
                    <div class="text-zinc-700 italic font-black text-4xl">${getV(r, 'Round')}</div>
                </div>`).join('');
        }

        async function loadStandings() {
            const data = await fetchWithAuth(`${BASE_URL}/f1/standings/drivers?year=${state.year}`);
            if (!data) return;
            document.getElementById('standings-body').innerHTML = data.map(s => {
                const d = getV(s, 'Driver');
                return `
                <tr onclick="openDriverStats(${getV(d, 'DriverID')})" class="border-b border-zinc-800/50 hover:bg-red-600/5 cursor-pointer transition">
                    <td class="p-6 font-mono font-black text-gray-600 text-lg">${getV(s, 'Position')}</td>
                    <td class="p-6 font-black text-white uppercase italic text-lg tracking-tight">${getV(d, 'Forename')} ${getV(d, 'Surname')}</td>
                    <td class="p-6 text-right font-black text-white text-2xl">${getV(s, 'Points')}</td>
                </tr>`}).join('');
        }

        async function openRaceDetail(id) {
            document.getElementById('race-modal').classList.remove('hidden');
            const data = await fetchWithAuth(`${BASE_URL}/f1/races/${id}`);
            document.getElementById('race-modal-header').innerHTML = `<h3 class="text-4xl font-black italic uppercase text-white tracking-tighter">${getV(data, 'Name')}</h3><div class="text-red-600 font-mono text-xs mt-2 uppercase tracking-[0.3em]">Official Classification</div>`;
            const results = getV(data, 'Results') || [];
            document.getElementById('race-modal-body').innerHTML = `
                <table class="w-full text-left mt-6">
                    <thead><tr class="text-gray-500 uppercase font-mono text-xs border-b border-zinc-800"><th class="pb-4">Pos</th><th class="pb-4">Driver</th><th class="pb-4 text-right">Points</th></tr></thead>
                    <tbody>${results.map(i => `<tr class="border-b border-zinc-900"><td class="py-4 text-red-600 font-black text-lg">${getV(i, 'PositionText')}</td><td class="py-4 font-black uppercase italic text-lg text-zinc-300">${getV(getV(i, 'Driver'), 'Forename')} ${getV(getV(i, 'Driver'), 'Surname')}</td><td class="py-4 text-right font-black text-white text-2xl">${getV(i, 'Points')}</td></tr>`).join('')}</tbody>
                </table>`;
        }

        async function openDriverStats(id) {
            document.getElementById('driver-modal').classList.remove('hidden');
            const content = document.getElementById('driver-modal-content');
            content.innerHTML = '<div class="text-center py-12 font-mono text-xs animate-pulse text-red-600">ACCESSING BIOMETRIC DATABASE...</div>';
            const d = await fetchWithAuth(`${BASE_URL}/f1/drivers/${id}/stats`);
            content.innerHTML = `
                <div class="text-center">
                    <h3 class="text-4xl font-black uppercase italic mb-10 tracking-tighter">Driver <span class="text-red-600">Profile</span></h3>
                    <div class="grid grid-cols-2 gap-6 mb-8">
                        <div class="bg-black/40 p-6 rounded-lg border border-zinc-800"><div class="text-[10px] text-gray-500 uppercase font-black mb-1">Race Wins</div><div class="text-4xl font-black">${getV(d, 'Wins') || 0}</div></div>
                        <div class="bg-black/40 p-6 rounded-lg border border-zinc-800"><div class="text-[10px] text-gray-500 uppercase font-black mb-1">Pole Positions</div><div class="text-4xl font-black">${getV(d, 'Poles') || 0}</div></div>
                    </div>
                    <div class="bg-red-600/10 p-8 border border-red-600/30 rounded-xl shadow-inner">
                        <div class="text-xs text-red-600 uppercase font-black tracking-widest mb-2">Total Career Points</div>
                        <div class="text-6xl font-black italic text-white">${Number(getV(d, 'Total_points') || 0).toFixed(1)}</div>
                    </div>
                </div>`;
        }

        async function loadQuestions() {
            const data = await fetchWithAuth(`${BASE_URL}/predictions/`); 
            const container = document.getElementById('questions-list');
            if(!data || data.length === 0) {
                container.innerHTML = '<div class="col-span-full py-24 text-center font-mono text-gray-600 uppercase tracking-widest">No active events in the paddock</div>';
                return;
            }
            container.innerHTML = data.map(q => `
                <div class="card p-8 border-l-8 border-red-600 shadow-xl">
                    <div class="flex justify-between items-start mb-6">
                        <h4 class="font-black italic uppercase text-2xl tracking-tighter text-white">${q.Title}</h4>
                        <span class="bg-red-600 text-white text-[10px] px-3 py-1 rounded-full font-black uppercase tracking-tighter">+${q.RewardXP} XP</span>
                    </div>
                    <p class="text-sm text-gray-400 mb-8 font-medium leading-relaxed">${q.Text}</p>
                    <div class="grid grid-cols-1 gap-3">
                        ${q.Options.map(o => `<button onclick="vote(${q.QuestionID}, ${o.OptionID})" class="w-full bg-zinc-900/50 p-4 text-xs font-black uppercase hover:bg-red-600 hover:text-white transition border border-zinc-800 text-left px-6 rounded-lg transform hover:scale-[1.02]">${o.Text}</button>`).join('')}
                    </div>
                </div>`).join('');
        }

        async function vote(qId, oId) {
            const res = await fetchWithAuth(`${BASE_URL}/predictions/vote`, {
                method: 'POST',
                body: JSON.stringify({ question_id: qId, option_id: oId })
            });
            alert(res.message || res.error || "Telemetry Transmitted");
            loadProfile();
            loadQuestions();
        }

        async function loadProfile() {
            const data = await fetchWithAuth(`${BASE_URL}/user/profile`);
            if (data && data.username) {
                document.getElementById('prof-name').innerText = data.username;
                document.getElementById('prof-xp').innerText = data.experience;
                document.getElementById('prof-rank').innerText = `#${data.rank}`;
                document.getElementById('mini-name').innerText = data.username;
                document.getElementById('mini-rank').innerText = `#${data.rank}`;
                if (data.is_admin) document.getElementById('nav-admin').classList.remove('hidden');
            }
        }

        async function handleCreateQuestion(e) {
            e.preventDefault();
            const optionsRaw = document.getElementById('admin-q-options').value;
            const payload = {
                title: document.getElementById('admin-q-title').value,
                text: document.getElementById('admin-q-text').value,
                reward_xp: parseInt(document.getElementById('admin-q-xp').value),
                options: optionsRaw.split(',').map(s => s.trim()).filter(s => s.length > 0)
            };
            const res = await fetchWithAuth(`${BASE_URL}/admin/questions`, {
                method: 'POST',
                body: JSON.stringify(payload)
            });
            if (res && !res.error) { alert("DATA DEPLOYED"); e.target.reset(); loadAdminQuestions(); } 
            else { alert(res.error || "Uplink Failed"); }
        }

        async function loadAdminQuestions() {
            const data = await fetchWithAuth(`${BASE_URL}/predictions/`); 
            const list = document.getElementById('admin-questions-list');
            if(!data || data.length === 0) { list.innerHTML = '<p class="text-gray-500 font-mono">No active questions</p>'; return; }
            list.innerHTML = data.map(q => `
                <div class="bg-black/50 p-6 rounded-xl border border-zinc-800">
                    <div class="text-lg font-black uppercase text-red-600 mb-1 italic tracking-tighter">${q.Title}</div>
                    <div class="text-xs text-gray-500 mb-4 leading-relaxed">${q.Text}</div>
                    <div class="grid grid-cols-2 gap-2">
                        ${q.Options.map(o => `
                            <button onclick="resolveQuestion(${q.QuestionID}, ${o.OptionID}, '${o.Text}')" class="w-full text-left bg-zinc-900 p-3 text-[10px] uppercase font-black hover:bg-white hover:text-black transition rounded">
                                Winner: ${o.Text}
                            </button>
                        `).join('')}
                    </div>
                </div>`).join('');
        }

        async function resolveQuestion(qId, oId, oText) {
            if (!confirm(`Confirm winner: ${oText}?`)) return;
            const res = await fetchWithAuth(`${BASE_URL}/admin/questions/${qId}/resolve`, {
                method: 'PATCH',
                body: JSON.stringify({ correct_option_id: oId })
            });
            if(res) { alert(`Broadcast Successful! Winners: ${res.winners_count}`); loadAdminQuestions(); loadProfile(); }
        }

        function changeYear(v) { state.year = v; init(); }
        function closeModal(id) { document.getElementById(id).classList.add('hidden'); }
        function logout() { localStorage.removeItem('f1_token'); location.reload(); }
        function init() { loadRaces(); loadStandings(); }

        if (state.token) enterDashboard();
    </script>
</body>
</html>